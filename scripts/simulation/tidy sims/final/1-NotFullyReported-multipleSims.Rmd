---
title: "Sims"
author: "Yang Xiao"
date: "2024-10-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(cmdstanr)
library(splines)
library(ggplot2)
library(reshape2)
library(dplyr)
```


```{r}
path_proj = here::here()
path_source = file.path(path_proj, "source")

# source(file.path(path_source, "simulation", "simulations_functions.R"))
source(file.path(path_source, "simulation", "simulations_functions_final.R"))

source(file.path(path_source, "functions", "plot_function.R"))
source(file.path(path_source, "functions", "fit_function.R"))
source(file.path(path_source, "functions", "table_function.R"))
```

```{r}
#models
fixed_q <- file.path(path_proj, "source", "models",
                     "trunc", "1.stan_model_fixed_q_trunc.stan")
fixed_b <- file.path(path_proj, "source", "models",
                     "trunc", "2.stan_model_fixed_b_trunc.stan")
linear_b <- file.path(path_proj, "source", "models", "trunc",
                     "3.stan_model_linear_b_trunc.stan")
# ou_b <- file.path(path_proj, "source", "models", "trunc",
#                      "4.stan_model_ou_b_trunc.stan")

ou_b <-  file.path(path_proj, "source", "models", "trunc",
                      "4.stan_model_ou_b_trunc.stan")

compiled_models <- list(
  fixed_q = cmdstan_model(fixed_q),
  fixed_b = cmdstan_model(fixed_b),
  linear_b = cmdstan_model(linear_b),
  ou_b = cmdstan_model(ou_b)
)
```


## simulate data

### settings and data
```{r}
###### setting #####
seed <- 123
set.seed(seed)

num_sims <- 2
# data
alpha_increase_seq_1 <- seq(10, 750, by = 30)
alpha_decrease_seq_1 <- seq(750, 10, by = -30)
alpha_lamb =  c( rep(10,5), alpha_increase_seq_1 + rnorm(alpha_increase_seq_1,10,10), 
                 alpha_decrease_seq_1 + rnorm(alpha_decrease_seq_1,10,10),
                 rep(10,5))
beta_lamb = 0.5
n_obs = 60
# reprot structure
D <- 10; D_complete <- 20; if_fully_reported <- F
# model
method = "ou"; 
alpha_ou=0.4; mu_ou=0.1; b_init=0.1; 
# sd changes for each scenario
sigma_ou_1 = 0.01; sigma_ou_2 = 0.1; sigma_ou_3 = 0.3

# input list
params_1 <- list(
  data = list(
    alpha_lamb = alpha_lamb,  
    beta_lamb  = beta_lamb,
    n_obs       = n_obs,
    date_start = as.Date("2024-01-01"),
    seed       = seed
  ),
  reporting = list(
    D           = D,     
    D_complete        = D_complete,    
    if_fully_reported = if_fully_reported
  ),
  q_model = list(
    method        = method,
    method_params = list(alpha = alpha_ou, mu = mu_ou, 
                         b_init = b_init, sigma_ou = sigma_ou_1)
  )
)
# date that we run
#scoreRange <- seq(as.Date("2024-01-15"),as.Date("2024-02-29"),by="14 day")
#scoreRange <- c(as.Date("2024-01-29"),as.Date("2024-02-12"), as.Date("2024-02-26"))

scoreRange <- c(as.Date("2024-01-29"),as.Date("2024-02-12"))

NFR_1 <- list()
# generate
for (i in 1:num_sims) {
  NFR_1[[i]] <- simulateData(
        params_1 <- list(
      data = list(
        alpha_lamb = alpha_lamb,  
        beta_lamb  = beta_lamb,
        n_obs       = n_obs,
        date_start = as.Date("2024-01-01"),
        seed       = i
      ),
      reporting = list(
        D           = D,     
        D_complete        = D_complete,    
        if_fully_reported = if_fully_reported
      ),
      q_model = list(
        method        = method,
        method_params = list(alpha = alpha_ou, mu = mu_ou, 
                             b_init = b_init, sigma_ou = sigma_ou_1)
      )
    )
  )
}
```


```{r}
# input list
params_2 <- list(
  data = list(
    alpha_lamb = alpha_lamb,  
    beta_lamb  = beta_lamb,
    n_obs       = n_obs,
    date_start = as.Date("2024-01-01"),
    seed       = seed
  ),
  reporting = list(
    D           = D,     
    D_complete        = D_complete,    
    if_fully_reported = if_fully_reported
  ),
  q_model = list(
    method        = method,
    method_params = list(alpha = alpha_ou, mu = mu_ou, 
                         b_init = b_init, sigma_ou = sigma_ou_2)
  )
)

NFR_2 <- simulateData(params_2)
```


```{r}
# input list
params_3 <- list(
  data = list(
    alpha_lamb = alpha_lamb,  
    beta_lamb  = beta_lamb,
    n_obs       = n_obs,
    date_start = as.Date("2024-01-01"),
    seed       = seed
  ),
  reporting = list(
    D           = D,     
    D_complete        = D_complete,    
    if_fully_reported = if_fully_reported
  ),
  q_model = list(
    method        = method,
    method_params = list(alpha = alpha_ou, mu = mu_ou, 
                         b_init = b_init, sigma_ou = sigma_ou_3)
  )
)

NFR_3 <- simulateData(params_3)
# sum(abs(NFR_3$b_t - NFR_2$b_t))
# 
# sum(abs(NFR_3$b_t - NFR_1$b_t))
```


## fit model
```{r}
out_list_1_NFR <- list()
for (i in 1:num_sims){
  out_list_1_NFR[[i]] <- 
    nowcasting_moving_window(NFR_1[[i]]$case_reported, scoreRange = scoreRange, 
                                case_true = NFR_1[[i]]$case_true,
                                start_date = as.Date("2024-01-01"),
                                D = D, seeds = seed,
                                #models_to_run =c("fixed_q", "fixed_b", "linear_b", "ou_b"),
                                models_to_run =c("fixed_q",  "ou_b"),
                                compiled_models = compiled_models,
                                iter_sampling = 2000, iter_warmup = 1000, refresh = 0,
                                num_chains = 3, suppress_output = T)
}

#save(out_1_NFR, file = file.path(path_proj, "data", "fitted_model", "simulation_ou", "NotFR_b01_sd001.RData"))
#load(file.path(path_proj,"data", "fitted_model", "simulation", "NotFR_b01_sd001.RData"))


# results_1_NFR_plots <- nowcasts_plot(results_1_NFR, D = D, report_unit = "day", models_to_run = c("fixed_q", "fixed_b", "linear_b" , "ou_b"))
```
```{r}
results_1_NFR <- compute_all_nowcasts_tables(out_list_1_NFR, D, "day", c("fixed_q","ou_b"))

# plots
results_1_NFR_avg <- average_nowcasts_tables(results_1_NFR)

nowcasts_plot(
  nowcasts_list = results_1_NFR_avg,
  D = D,
  report_unit = "day",
  models_to_run = c("fixed_q","ou_b"),
  combine_plots = TRUE,
  title = "Averaged Nowcasts Over All Replicates"
)

# Average metrics
metrics_1_NFR_avg <- average_nowcasts_metrics(
  results_all   = results_1_NFR,
  methods       = c("fixed_q","ou_b")
)

metrics_1_NFR_avg


#
# for (t in seq_along(metrics_1_NFR_avg)) {
#   cat("===== Window", t, "=====\n")
#   print(metrics_1_NFR_avg[[t]])
# }
```

```{r}
results_1_NFR <- list()
all_metrics_1_NFR <- list()
for (i in 1:num_sims){
results_1_NFR[[i]] <- nowcasts_table(out_list_1_NFR[[i]], D = D, report_unit = "day", 
                          models_to_run =c("fixed_q",  "ou_b"),                          replicate_id = i)
}


for (i in 1:num_sims){
  table_i_list <- results_1_NFR[[i]]
  metrics_i_list <- list()
    for (t in seq_along(table_i_list)) {
    df_rt <- table_i_list[[t]]
    
    # Compute metrics for replicate r, time window t
    metrics_rt <- calculate_metrics(df_rt,
                                    methods = c("fixed_q",  "ou_b"))
    
    metrics_i_list[[t]] <- metrics_rt
    }
  all_metrics_1_NFR[[i]] <- metrics_i_list
}

# combine
T <- length(all_metrics_1_NFR[[1]])

# We'll store T final "averaged" metrics data frames
metrics_t_averaged_1_NFR <- vector(mode="list", length=T)

for (t in seq_len(T)) {
  # Extract metrics from all replicates for this time window
  metrics_for_t_list <- list()
  for (i in seq_len(num_sims)) {
    metrics_for_t_list[[i]] <- all_metrics_1_NFR[[i]][[t]]
    # which has columns like: RMSE, RMSPE, MAPE, Interval_Width, Coverage_Rate, Method
    # Possibly you want to add replicate_id = r here, if not already
  }
  
  # Combine row-wise
  metrics_for_t <- dplyr::bind_rows(metrics_for_t_list)
  
  # Now average across replicate
  # Typically group by "Method" to compute average metrics
  metrics_avg_t <- metrics_for_t %>%
    group_by(Method) %>%
    summarize(
      RMSE = mean(RMSE, na.rm=TRUE),
      RMSPE = mean(RMSPE, na.rm=TRUE),
      MAE = mean(MAE, na.rm=TRUE),
      MAPE = mean(MAPE, na.rm=TRUE),
      Interval_Width = mean(Interval_Width, na.rm=TRUE),
      Coverage_Rate = mean(Coverage_Rate, na.rm=TRUE),
      .groups = "drop"
    )
  
  # Optionally round or reorder
  metrics_avg_t <- metrics_avg_t %>%
    mutate_if(is.numeric, round, 2)
  
  # store final table for window t
  metrics_t_averaged_1_NFR[[t]] <- metrics_avg_t
}

```
```{r}
library(dplyr)

# Number of time windows
T <- length(results_1_NFR[[1]])  # assume all replicates have the same T windows

# Prepare a list to hold the T averaged data frames
results_1_NFR_avg <- vector("list", length = T)

for (t in seq_len(T)) {
  # Gather the data frames from each replicate for this time window t
  df_list_t <- lapply(seq_len(num_sims), function(i) results_1_NFR[[i]][[t]])
  # Each df_list_t[[i]] is a data frame with columns like
  # date, case_true, case_reported, mean_fixed_q, lower_fixed_q, ..., mean_ou_b, lower_ou_b, upper_ou_b, etc.

  # We'll create an averaged data frame for time window t
  # Let's assume that each replicate's df has the same rows in the same order.

  # Start with a copy of the first replicate's data frame as a "template"
  df_avg_t <- df_list_t[[1]]

  # Identify numeric columns to average.
  # For instance, we might want to average:
  #   case_true, case_reported,
  #   mean_fixed_q, lower_fixed_q, upper_fixed_q,
  #   mean_ou_b,    lower_ou_b,    upper_ou_b
  # Possibly exclude "date" or anything not numeric.
  numeric_cols <- c("case_true","case_reported",
                    "mean_fixed_q","lower_fixed_q","upper_fixed_q",
                    "mean_ou_b",   "lower_ou_b",   "upper_ou_b")

  # For each numeric col, compute row-wise mean across all replicates
  for (colname in numeric_cols) {
    vals <- sapply(df_list_t, function(df) df[[colname]])  
    # vals is a matrix: row = each date, column = each replicate
    # Now compute row means
    df_avg_t[[colname]] <- rowMeans(vals, na.rm = TRUE)
  }

  # (Optional) If replicate data frames have 'replicate_id' or other columns, you can remove or keep them
  df_avg_t$replicate_id <- NULL

  # Store the averaged data frame for window t
  results_1_NFR_avg[[t]] <- df_avg_t
}


p <- nowcasts_plot(
  nowcasts_list = results_1_NFR_avg, 
  D = D, 
  report_unit = "day",
  models_to_run = c("fixed_q","ou_b"),  # whichever models you included
  title = "Averaged Nowcasts Over All Simulations",
  combine_plots = TRUE  # show all T windows in a grid
)
p

```



```{r}
out_2_NFR <- nowcasting_moving_window(NFR_2$case_reported, scoreRange = scoreRange, 
                                case_true = NFR_2$case_true,
                                start_date = as.Date("2024-01-01"),
                                D = D, sigma_b = 0.1, seeds = seed,
                                models_to_run =c("fixed_q", "fixed_b", "linear_b", "ou_b"),
                                compiled_models = compiled_models,
                                iter_sampling = 2000, iter_warmup = 1000, refresh = 0,
                                num_chains = 3, suppress_output = T)


#save(out_2_NFR, file = file.path(path_proj, "data", "fitted_model", "simulation_ou", "NotFR_b01_sd01.RData"))
#load(file.path(path_proj,"data", "fitted_model", "simulation", "NotFR_b01_sd001.RData"))

results_2_NFR <- nowcasts_table(out_2_NFR, D = D, report_unit = "day", 
                          models_to_run = c("fixed_q", "fixed_b", "linear_b", "ou_b"))

results_2_NFR_plots <- nowcasts_plot(results_2_NFR, D = D, report_unit = "day", models_to_run = c("fixed_q", "fixed_b", "linear_b" , "ou_b"))
``` 


```{r}
out_3_NFR <- nowcasting_moving_window(NFR_3$case_reported, scoreRange = scoreRange, 
                                case_true = NFR_3$case_true,
                                start_date = as.Date("2024-01-01"),
                                D = D, sigma_b = 0.1, seeds = seed,
                                models_to_run =c("fixed_q", "fixed_b", "linear_b", "ou_b"),
                                compiled_models = compiled_models,
                                iter_sampling = 2000, iter_warmup = 1000, refresh = 0,
                                num_chains = 3, suppress_output = T)


#save(out_3_NFR, file = file.path(path_proj, "data", "fitted_model", "simulation_ou", "NotFR_b01_sd03.RData"))
#load(file.path(path_proj,"data", "fitted_model", "simulation", "NotFR_b01_sd001.RData"))

results_3_NFR <- nowcasts_table(out_3_NFR, D = D, report_unit = "day", 
                          models_to_run = c("fixed_q", "fixed_b", "linear_b", "ou_b"))

results_3_NFR_plots <- nowcasts_plot(results_3_NFR, D = D, report_unit = "day", models_to_run = c("fixed_q", "fixed_b", "linear_b" , "ou_b"))

```


## check results
```{r}
results_1_NFR_plots
```

```{r}
# all cases
for(i in 1:length(results_1_NFR)){
  print(calculate_metrics(results_1_NFR[[i]]))
}
```

```{r}
# Within D
for(i in 1:length(results_1_NFR)){
  print(calculate_metrics(data.table::last(results_1_NFR[[i]], D)))
}
```


# sigma_rw = 0.1

```{r}
results_2_NFR_plots
```

```{r}
# all cases
for(i in 1:length(results_2_NFR)){
  print(calculate_metrics(results_2_NFR[[i]]))
}

```

```{r}
# Within D
for(i in 1:length(results_2_NFR)){
  print(calculate_metrics(data.table::last(results_2_NFR[[i]], D)))
}
```


# sigma_rw = 0.3
```{r}
results_3_NFR_plots
```

```{r}
# all cases
for(i in 1:length(results_3_NFR)){
  print(calculate_metrics(results_3_NFR[[i]]))
}
```

```{r}
# Within D
for(i in 1:length(results_3_NFR)){
  print(calculate_metrics(data.table::last(results_3_NFR[[i]], D)))
}
```


# output
```{r}
results_1_NFR_plots <- nowcasts_plot(results_1_NFR, D = D, report_unit = "day",
                                 models_to_run = c("fixed_q", "fixed_b", "linear_b" , "ou_b"),
                                 combine_plots = T, ncol = 2
                                 )

ggsave(filename = file.path(path_proj, "plots_to_show", "simulation", "NotFR_b01_sd001.png"), 
       plot = results_1_NFR_plots, 
       width = 10, height = 12, dpi = 300)
# table
fully_tables_1 <- list();count_1 = 1
for (i in 1:length(scoreRange)) {
  fully_tables_1[[count_1]] <- calculate_metrics(results_1_NFR[[i]])
  count_1 = count_1 + 1
}
cat(highlight_metrics(fully_tables_1, method_names =c("Fixed q", "Fixed b", "Polynomial b" , "Random Walk b"),
                  date_labels = as.character(scoreRange)))

```

# output
```{r}
results_2_NFR_plots <- nowcasts_plot(results_2_NFR, D = D, report_unit = "day",
                                 models_to_run = c("fixed_q", "fixed_b", "linear_b" , "ou_b"),
                                 combine_plots = T, ncol = 2
                                 )

ggsave(filename = file.path(path_proj, "plots_to_show", "simulation", "NotFR_b01_sd01.png"), 
       plot = results_2_NFR_plots, 
       width = 10, height = 12, dpi = 300)
# table
fully_tables_2 <- list();count_2 = 1
for (i in 1:length(scoreRange)) {
  fully_tables_2[[count_2]] <- calculate_metrics(results_2_NFR[[i]])
  count_2 = count_2 + 1
}
cat(highlight_metrics(fully_tables_2, method_names =c("Fixed q", "Fixed b", "Polynomial b" , "Random Walk b"),
                  date_labels = as.character(scoreRange)))

```

```{r}
results_3_NFR_plots <- nowcasts_plot(results_3_NFR, D = D, report_unit = "day",
                                 models_to_run = c("fixed_q", "fixed_b", "linear_b" , "ou_b"),
                                 combine_plots = T, ncol = 2
                                 )

ggsave(filename = file.path(path_proj, "plots_to_show", "simulation", "NotFR_b01_sd03.png"), 
       plot = results_3_NFR_plots, 
       width = 10, height = 12, dpi = 300)
# table
fully_tables_3 <- list();count_3 = 1
for (i in 1:length(scoreRange)) {
  fully_tables_3[[count_3]] <- calculate_metrics(results_3_NFR[[i]])
  count_3 = count_3 + 1
}
cat(highlight_metrics(fully_tables_3, method_names =c("Fixed q", "Fixed b", "Polynomial b" , "Random Walk b"),
                  date_labels = as.character(scoreRange)))

```