---
title: "Time-varying parametric reported probability: OU process"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(cmdstanr)
library(splines)
library(ggplot2)
library(reshape2)
library(dplyr)
library(bayesplot)
```

```{r}
path_proj = here::here()
path_source = file.path(path_proj, "source")

source(file.path(path_source, "simulation", "simulations_functions_final.R"))
source(file.path(path_source, "functions", "plot_function.R"))
source(file.path(path_source, "functions", "fit_function.R"))
source(file.path(path_source, "functions", "table_function.R"))
posterior_draws_path = file.path(path_proj, "data", "draws", "testEach")
```

```{r}
ou_b <-  file.path(path_proj, "source", "models", "b-ou.stan")
model <- cmdstan_model(ou_b)
```

## Fully reported scenario

### Setting

```{r}
# data
alpha_increase_seq_1 <- seq(10, 750, by = 30)
alpha_decrease_seq_1 <- seq(750, 10, by = -30)
alpha_lamb =  c( rep(10,5), alpha_increase_seq_1 + rnorm(alpha_increase_seq_1,10,10),
                 alpha_decrease_seq_1 + rnorm(alpha_decrease_seq_1,10,10),
                 rep(10,5))
beta_lamb = 0.5
N_obs = 60
D <- 15;
```

### Simulation

```{r}
params_ou_b_FR <- list(
  data = list(
    alpha_lamb = alpha_lamb,
    beta_lamb  = beta_lamb,
    N_obs       = N_obs,
    date_start = as.Date("2024-01-01"),
    D = D
  ),
  q_model = list(
    method        = "ou_b",
    method_params = list(b_theta = 0.3, b_mu = log(0.7), b_init = log(0.7), b_sigma = 0.2,
                         phi_theta = 0.3, phi_mu = 1, phi_init = 1, phi_sigma = 0.2)
  )
)
ou_b_FR <- simulateData(params_ou_b_FR)
par(mfrow = c(2, 1))
plot(ou_b_FR$b, pch = 19, type = "b")
plot(ou_b_FR$phi, pch = 19, type = "b")

par(mfrow = c(1, 1))
matplot(t(ou_b_FR$qd), type = "l", lty = 1, ylim = c(0, 1))
```

### Exploratory analysis

```{r}
page_num <- ceiling(nrow(ou_b_FR$case_reported_cumulated)/16)
exp_plot_ou <- fit_exp_plot(ou_b_FR$case_reported_cumulated,ncol = 4, nrow = 4, page = c(1:page_num), if_fit = T)
exp_plot_ou$plots[[1]]
exp_plot_ou$plots[[4]]

exp_plot_ou$coefficients
exp_b_data_ou<- data.frame( date = as.Date(rownames(ou_b_FR$case_reported_cumulated)),
                          b = exp_plot_ou$coefficients$b)
exp_b_plot_ou <- ggplot(exp_b_data_ou, aes(x = date, y = b)) +
  geom_point(color = "black", size = 1.5) +
  geom_smooth(method = "loess", se = TRUE,
              color = "blue", fill = "grey", alpha = 0.5) +
  theme_minimal() +
  labs(x = NULL, y = "Y", title = "Smoothed Curve of parameter b")
print(exp_b_plot_ou)
```

### Model fitting

```{r}
ind = 40
stan_data <- list(T = ind, D = 15, Y = ou_b_FR$case_reported_cumulated[1:ind, ])
test = model$sample(
    data = stan_data,
    iter_sampling = 3000,
    iter_warmup = 2000,
    chains = 1,
    refresh = 0,
    thin = 1)
varnames <- test$summary()$variable

mcmc_areas(test$draws("sigma_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("sigma_logit_phi"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("theta_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("theta_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test$draws("mu_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("mu_logit_phi"), prob = 0.95, prob_outer = 0.95)


param_true = tibble(
    parameter = grep("^b\\[.+\\]$", varnames, value = TRUE),
    x = ou_b_FR$b[1:ind]
)
mcmc_areas(test$draws("b"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^phi\\[.+\\]$", varnames, value = TRUE),
    x = ou_b_FR$phi[1:ind]
)
mcmc_areas(test$draws("phi"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^lambda\\[.+\\]$", varnames, value = TRUE),
    x = ou_b_FR$lambda_t[1:ind]
)
mcmc_areas(test$draws("lambda"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^q\\[10,.+\\]$", varnames, value = TRUE),
    x = ou_b_FR$qd[10,]
)
mcmc_areas(test$draws(grep("^q\\[10,.+\\]$", varnames, value = TRUE)), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^N\\[.+\\]$", varnames, value = TRUE),
    x = ou_b_FR$case_true[1:ind, 1]
)
mcmc_areas(test$draws("N"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)
```

## Non-fully reported scenario

### Simulation

```{r}
# ou_NFR
params_ou_b_NFR <- list(
  data = list(
    alpha_lamb = alpha_lamb,
    beta_lamb  = beta_lamb,
    N_obs       = N_obs,
    date_start = as.Date("2024-01-01"),
    D = D
  ),
  q_model = list(
    method        = "ou_b",
    method_params = list(b_theta = 0.2, b_mu = log(0.2), b_init = log(0.2), b_sigma = 0.15,
                         phi_theta = 0.2, phi_mu = 1.5, phi_init = 1.5, phi_sigma = 0.15)
  )
)

ou_b_NFR <- simulateData(params_ou_b_NFR)
par(mfrow = c(2, 1))
plot(ou_b_NFR$b, pch = 19, type = "b")
plot(ou_b_NFR$phi, pch = 19, type = "b")
par(mfrow = c(1, 1))
matplot(t(ou_b_NFR$qd), type = "l", lty = 1, ylim = c(0, 1))
```

### Exploratory analysis

```{r}
page_num <- ceiling(nrow(ou_b_NFR$case_reported_cumulated)/16)
exp_plot_rw_b <- fit_exp_plot(ou_b_NFR$case_reported_cumulated,ncol = 4, nrow = 4, page = c(1:page_num), if_fit = T)
print(exp_plot_rw_b)

exp_plot_rw_b$coefficients
exp_b_data_rw_b<- data.frame( date = as.Date(rownames(ou_b_NFR$case_reported_cumulated)),
                          b = exp_plot_rw_b$coefficients$b)
exp_b_plot_rw_b <- ggplot(exp_b_data_rw_b, aes(x = date, y = b)) +
  geom_point(color = "black", size = 1.5) +
  geom_smooth(method = "loess", se = TRUE,
              color = "blue", fill = "grey", alpha = 0.5) +
  theme_minimal() +
  labs(x = NULL, y = "Y", title = "Smoothed Curve of parameter b")
print(exp_b_plot_rw_b)
```

### Model fitting

```{r}
ind = 40
stan_data <- list(T = ind, D = 15, Y = ou_b_NFR$case_reported_cumulated[1:ind, ])
test = model$sample(
    data = stan_data,
    iter_sampling = 3000,
    iter_warmup = 3000,
    chains = 1,
    refresh = 0,
    thin = 1)
varnames <- test$summary()$variable

mcmc_areas(test$draws("sigma_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("sigma_logit_phi"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("theta_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("theta_logit_phi"), prob = 0.95, prob_outer = 0.95)

mcmc_areas(test$draws("mu_log_b"), prob = 0.95, prob_outer = 0.95)
mcmc_areas(test$draws("mu_logit_phi"), prob = 0.95, prob_outer = 0.95)


param_true = tibble(
    parameter = grep("^b\\[.+\\]$", varnames, value = TRUE),
    x = ou_b_NFR$b[1:ind]
)
mcmc_areas(test$draws("b"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^phi\\[.+\\]$", varnames, value = TRUE),
    x = ou_b_NFR$phi[1:ind]
)
mcmc_areas(test$draws("phi"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^lambda\\[.+\\]$", varnames, value = TRUE),
    x = ou_b_NFR$lambda_t[1:ind]
)
mcmc_areas(test$draws("lambda"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^q\\[10,.+\\]$", varnames, value = TRUE),
    x = ou_b_NFR$qd[10,]
)
mcmc_areas(test$draws(grep("^q\\[10,.+\\]$", varnames, value = TRUE)), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)

param_true = tibble(
    parameter = grep("^N\\[.+\\]$", varnames, value = TRUE),
    x = ou_b_NFR$case_true[1:ind, 1]
)
mcmc_areas(test$draws("N"), prob_outer = 0.95) +
    geom_point(aes(x = x), param_true, color = "red", size = 1)
```

